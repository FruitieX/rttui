name: Release

on:
        push:
                tags:
                        - "v*"

env:
        CARGO_TERM_COLOR: always

jobs:
        build:
                name: Build ${{ matrix.target }}
                runs-on: ${{ matrix.os }}
                strategy:
                        fail-fast: false
                        matrix:
                                include:
                                        - target: x86_64-unknown-linux-gnu
                                          os: ubuntu-latest
                                          archive: tar.gz
                                        - target: x86_64-unknown-linux-musl
                                          os: ubuntu-latest
                                          archive: tar.gz
                                        - target: x86_64-pc-windows-msvc
                                          os: windows-latest
                                          archive: zip
                                        - target: aarch64-unknown-linux-gnu
                                          os: ubuntu-latest
                                          archive: tar.gz

                steps:
                        - uses: actions/checkout@v4

                        - name: Install Rust
                          uses: dtolnay/rust-toolchain@nightly
                          with:
                                  targets: ${{ matrix.target }}

                        - name: Install musl-tools (Linux musl)
                          if: matrix.target == 'x86_64-unknown-linux-musl'
                          run: sudo apt-get update && sudo apt-get install -y musl-tools

                        - name: Install cross-compilation tools (aarch64)
                          if: matrix.target == 'aarch64-unknown-linux-gnu'
                          run: |
                                  sudo apt-get update
                                  sudo apt-get install -y gcc-aarch64-linux-gnu

                        - uses: Swatinem/rust-cache@v2
                          with:
                                  key: ${{ matrix.target }}

                        - name: Build
                          run: cargo build --release --target ${{ matrix.target }}
                          env:
                                  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

                        - name: Package (Unix)
                          if: matrix.os != 'windows-latest'
                          run: |
                                  cd target/${{ matrix.target }}/release
                                  tar czvf ../../../pinggraph-${{ github.ref_name }}-${{ matrix.target }}.tar.gz pinggraph
                                  cd ../../..

                        - name: Package (Windows)
                          if: matrix.os == 'windows-latest'
                          run: |
                                  cd target/${{ matrix.target }}/release
                                  7z a ../../../pinggraph-${{ github.ref_name }}-${{ matrix.target }}.zip pinggraph.exe
                                  cd ../../..

                        - name: Upload artifact
                          uses: actions/upload-artifact@v4
                          with:
                                  name: pinggraph-${{ matrix.target }}
                                  path: pinggraph-${{ github.ref_name }}-${{ matrix.target }}.*

        release:
                name: Create Release
                needs: build
                runs-on: ubuntu-latest
                permissions:
                        contents: write
                steps:
                        - uses: actions/checkout@v4

                        - name: Download all artifacts
                          uses: actions/download-artifact@v4
                          with:
                                  path: artifacts

                        - name: Create Release
                          uses: softprops/action-gh-release@v2
                          with:
                                  files: artifacts/**/*
                                  generate_release_notes: true
                                  draft: false
                                  prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
